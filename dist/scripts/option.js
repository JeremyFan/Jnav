function initButtonEvent(){var t=document.querySelector("#btnSiteCreate"),e=document.querySelector("#btnCataCreate"),n=document.querySelector("#export"),o=document.querySelector("#import"),a=document.querySelector("#import-file");t.onclick=function(){showBox(this,BoxType.Sitebox)},e.onclick=function(){showBox(this,BoxType.Catabox)},n.onclick=function(){exportOptionFile(this)},o.onclick=function(){importOptionFile(this)},a.onchange=function(){setImportData(this)}}function initNav(){var t,e,n,o,a,i=(document.querySelectorAll(".main .nav"),document.querySelectorAll(".main .nav li")),c=document.querySelectorAll(".main .nav li a"),r=document.querySelectorAll(".main .tab");for(n=0;n<c.length;n++)c[n].onclick=function(){for(t=this.parentNode,e=$(this.attributes.href.value),o=0;o<i.length;o++)i[o].removeClass("active");for(t.addClass("active"),a=0;a<r.length;a++)r[a].removeClass("active");e.addClass("active")}}function initData(){var t=document.querySelector("#tbSite tbody"),e=document.querySelector("#ulCatalog");chrome.storage.sync.get(function(n){window.result=n;var o,a,i,c,r=[];cataArr=[];for(a in n)o=n[a],"cata"===o.type?cataArr.push(o):"site"===o.type&&r.push(o);for(t.innerHTML="",a=0;a<r.length;a++)o=r[a],i=document.createElement("tr"),i.id=o.id,i.setAttribute("data-name",o.name),i.setAttribute("data-url",o.url),i.setAttribute("data-catalog",o.catalog),i.innerHTML="<td>"+o.name+"</td><td>"+o.url+"</td><td>"+o.catalog+"</td>",i.onclick=function(){showBox(this,BoxType.Sitebox)},t.appendChild(i);for(e.innerHTML="",a=0;a<cataArr.length;a++)o=cataArr[a],c=document.createElement("li"),c.id=o.id,c.setAttribute("data-name",o.name),c.innerHTML=o.name,c.onclick=function(){showBox(this,BoxType.Catabox)},e.appendChild(c)})}function showBox(t,e){var n,o="button"===t.type,a=document.body,i=document.createElement("div"),c=document.documentElement.scrollHeight,r=document.documentElement.scrollWidth;document.querySelector("#tabCatalog");i.id="mask",a.appendChild(i),i.style.height=c+"px",i.style.width=r+"px",e===BoxType.Sitebox?(n=createSitebox(a,t,o),initSiteEvent(a,i,n,t,o)):e===BoxType.Catabox&&(n=createCatabox(a,t,o),initCataEvent(a,i,n,t,o))}function initSiteEvent(t,e,n,o,a){var i=document.querySelector(".sitebox .btn-del"),c=document.querySelector(".sitebox #btnSiteSave"),r=document.querySelector(".sitebox #btnSiteCancel"),l=document.querySelector(".sitebox .close");a||(i.onclick=function(){confirm("确定吗？")&&chrome.storage.sync.remove(o.id,function(){t.removeChild(e),t.removeChild(n),initData()})}),c.onclick=function(){var i,c=document.querySelector(".sitebox .name").value,r=document.querySelector(".sitebox .url").value,l=document.querySelector("#selCatalog").value,u={};return""===c||""===r||""===l?void alert("请输入catalog name"):void(a?(u[c]={id:c,name:c,url:r,catalog:l,type:"site"},chrome.storage.sync.set(u,function(){t.removeChild(e),t.removeChild(n),initData()})):(i=o.id,u[i]={id:i,name:c,url:r,catalog:l,type:"site"},chrome.storage.sync.set(u,function(){t.removeChild(e),t.removeChild(n),initData()})))},r.onclick=l.onclick=e.onclick=function(){t.removeChild(e),t.removeChild(n)}}function initCataEvent(t,e,n,o,a){var i=document.querySelector(".catabox .btn-del"),c=document.querySelector(".catabox #btnCataSave"),r=document.querySelector(".catabox #btnCataCancel"),l=document.querySelector(".catabox .close");a||(i.onclick=function(){confirm("确定吗？")&&chrome.storage.sync.remove(o.id,function(){t.removeChild(e),t.removeChild(n),initData()})}),c.onclick=function(){var i,c=document.querySelector(".catabox .name").value,r={};return""===c?void alert("请输入catalog name"):void(a?(r[c]={id:c,name:c,type:"cata"},chrome.storage.sync.set(r,function(){t.removeChild(e),t.removeChild(n),initData()})):(i=o.id,r[i]={id:i,name:c,type:"cata"},chrome.storage.sync.set(r,function(){t.removeChild(e),t.removeChild(n),initData()})))},r.onclick=l.onclick=e.onclick=function(){t.removeChild(e),t.removeChild(n)}}function createSitebox(t,e,n){var o,a=document.createElement("div");return a.className="sitebox active",a.innerHTML='<h3 class="title">'+(n?"新建地址":"编辑地址")+"</h3>"+(n?"":'<a class="btn-del">我要删除这个地址</a>')+'<span class="close">x</span>名称：<input type="text" class="name" placeholder="site name"'+(n?"":'value="'+e.attributes["data-name"].value+'"')+'/>地址：<input type="text" class="url" placeholder="http://"'+(n?"":'value="'+e.attributes["data-url"].value+'"')+' />分类：<select id="selCatalog"></select><div class="button-wrap"><button type="button" class="btn-ok" id="btnSiteSave">保存</button><button type="button" id="btnSiteCancel">取消</button></div>',t.appendChild(a),a.style.top=getElementOffsetTop(e)+"px",a.style.left=getElementOffsetLeft(e)+"px",o=e.attributes["data-catalog"],initSelCatalog(o?o.value:""),a}function initSelCatalog(t){var e,n,o,a=document.querySelector("#selCatalog"),i=cataArr;for(n=0;n<i.length;n++)e=i[n],o=document.createElement("option"),o.setAttribute("value",e.id),o.innerHTML=e.name,e.id===t&&o.setAttribute("selected","selected"),a.appendChild(o)}function createCatabox(t,e,n){var o=document.createElement("div");return o.className="catabox active",o.innerHTML='<h3 class="title">'+(n?"新建分类":"编辑分类")+"</h3>"+(n?"":'<a class="btn-del">我要删除这个分类</a>')+'<span class="close">x</span><input type="text" class="name" placeholder="catalog name"'+(n?"":'value="'+e.attributes["data-name"].value+'"')+'/><div class="button-wrap"><button type="button" class="btn-ok" id="btnCataSave">确定</button><button type="button" id="btnCataCancel">取消</button><button type="button" style="display:none;" id="btnCataSee">看看</button></div>',t.appendChild(o),o.style.top=getElementOffsetTop(e)+"px",o.style.left=getElementOffsetLeft(e)+"px",o}function getElementOffsetTop(t){for(var e=t.offsetTop,n=t.offsetParent;null!==n;)e+=n.offsetTop,n=n.offsetParent;return e}function getElementOffsetLeft(t){for(var e=t.offsetLeft,n=t.offsetParent;null!==n;)e+=n.offsetLeft,n=n.offsetParent;return e}function exportOptionFile(t){var e=formateDate(new Date),n="data:text/txt;",o="charset=utf-8,"+JSON.stringify(window.result);t.download="jnav-options-"+e+".txt",t.href=n+o}function formateDate(t){return t?[t.getFullYear(),t.getMonth(),t.getDate()].join(""):void 0}function importOptionFile(t){if(confirm("导入配置会覆盖删除现有网址和分类，确定要导入吗？")){var e=document.querySelector("#import-file");e.click()}}function setImportData(t){var e=new FileReader;e.onload=function(t,e,n,o){var a=JSON.parse(t.target.result);chrome.storage.sync.clear(),chrome.storage.sync.set(a,initData)};var t=document.querySelector("#import-file");t.files.length&&(file=t.files[0],e.readAsText(file))}window.onload=function(){initButtonEvent(),initNav(),initData()};var cataArr=[],BoxType={Sitebox:1,Catabox:2};